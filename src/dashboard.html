<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSINT Threat Intelligence</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #4c51bf;
      color: #1a202c;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header {
      background-color: #ffffff;
      color: #2d3748;
      padding: 1.5rem;
      text-align: center;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      justify-content: center;
      margin-top: 1rem;
    }
    .chip {
      background: #edf2f7;
      color: #2d3748;
      border-radius: 999px;
      padding: .5rem 1rem;
      font-size: .85rem;
      font-weight: 600;
      border: 2px solid #e2e8f0;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
    }
    .chip:hover { 
      filter: brightness(0.96); 
      transform: translateY(-1px);
    }
    .chip.active { 
      background: #3182ce; 
      color: #ffffff; 
      border-color: #3182ce; 
    }
    .container {
      padding: 1.5rem;
      max-width: 1400px;
      margin: 0 auto;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 1.5rem;
    }
    .card {
      grid-column: span 12;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    @media (min-width: 768px) {
      .span-6 { grid-column: span 6; }
      .span-4 { grid-column: span 4; }
    }
    @media (max-width: 767px) {
      .kpi-row { grid-template-columns: repeat(2, 1fr); }
      .chart-card { height: 320px; }
      .grid { gap: 1rem; }
    }
    .chart-card { height: 380px; }
    .card h3 { 
      margin: 0 0 1rem 0; 
      color: #2d3748;
      font-size: 1.1rem;
      font-weight: 700;
    }
    .card canvas { 
      width: 100% !important; 
      height: auto !important; 
      flex: 1 1 auto; 
      display: block; 
    }
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .kpi {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      padding: 1.5rem;
      text-align: center;
      transition: transform 0.2s;
    }
    .kpi:hover {
      transform: translateY(-2px);
    }
    .kpi h3 { 
      margin: 0 0 0.5rem 0; 
      color: #4a5568; 
      font-size: 0.85rem; 
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .kpi .num { 
      font-size: 2rem; 
      font-weight: bold; 
      color: #2b6cb0; 
    }
  </style>
</head>
<body>
  <header>
    <h1>OSINT Threat Intelligence Dashboard</h1>
    <div style="font-size:0.95rem;color:#718096;margin-top:0.5rem">Comprehensive threat analysis from multiple intelligence sources</div>
    <div class="chips" id="source-chips"></div>
  </header>
  <div class="container">
    <div class="kpi-row" id="kpis">
      <div class="kpi"><h3>Total Indicators</h3><div class="num" id="kpi-total">0</div></div>
      <div class="kpi"><h3>High Risk Threats</h3><div class="num" id="kpi-high">0</div></div>
      <div class="kpi"><h3>Medium Risk Threats</h3><div class="num" id="kpi-medium">0</div></div>
      <div class="kpi"><h3>Low Risk Threats</h3><div class="num" id="kpi-low">0</div></div>
    </div>

    <div class="grid">
      <div class="card chart-card span-6">
        <h3>Total Indicators by Source</h3>
        <canvas id="bySource"></canvas>
      </div>
      <div class="card chart-card span-6">
        <h3>Indicator Distribution by Type</h3>
        <canvas id="byType"></canvas>
      </div>
      <div class="card chart-card span-6">
        <h3>Threats by Confidence Level</h3>
        <canvas id="byConfidence"></canvas>
      </div>
      <div class="card chart-card span-6">
        <h3>Risk Score Distribution</h3>
        <canvas id="riskRadar"></canvas>
      </div>
      <div class="card chart-card span-6">
        <h3>Threat Timeline</h3>
        <canvas id="timeline"></canvas>
      </div>
      <div class="card chart-card span-6">
        <h3>Geographic Distribution</h3>
        <canvas id="geo"></canvas>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script>
    let rawData = [];
    let currentFilter = null;
    let charts = { bySource: null, byType: null, byConfidence: null, risk: null, timeline: null, geo: null };

    if (window.ChartDataLabels) { Chart.register(window.ChartDataLabels); }

    async function fetchData() {
      try {
        const response = await fetch('/data');
        if (!response.ok) throw new Error("Failed to fetch data: " + response.statusText);
        rawData = await response.json();
        renderAll();
      } catch (error) {
        console.error(error);
        alert("Error fetching data. Please ensure the backend is running.");
      }
    }

    function renderAll() {
      const filtered = currentFilter ? rawData.filter(r => (r.source||'') === currentFilter) : rawData;
      const { bySource, byType, byConfidence, scoreBuckets, timeline, geo } = aggregate(filtered);
      updateKpis(byConfidence, filtered.length);
      drawBySource(bySource);
      drawByType(byType);
      drawByConfidence(byConfidence);
      drawRiskRadar(scoreBuckets);
      drawTimeline(timeline);
      drawGeo(geo);
      const allSources = Object.keys(aggregate(rawData).bySource);
      renderSourceChips(allSources);
    }

    function aggregate(rows) {
      const bySource = {}, byType = {}, byConfidence = { High: 0, Medium: 0, Low: 0 };
      const scoreBuckets = { '0-20': 0, '21-40': 0, '41-60': 0, '61-80': 0, '81-100': 0 };
      const timeline = {}, geo = {};

      for (const r of rows) {
        const src = r.source || 'unknown';
        const t = (r.indicator_type || r.type || 'unknown').toLowerCase();
        const confRaw = (r.confidence || '').toString().toLowerCase();
        const score = Number(r.score || 0);
        const dateStr = (r.last_seen || r.first_seen || '').toString().slice(0,10);
        const country = (r.geo && r.geo.country) ? r.geo.country : 'N/A';

        bySource[src] = (bySource[src] || 0) + 1;
        byType[t] = (byType[t] || 0) + 1;

        let bucket = 'Medium';
        if (['high','hi','h'].includes(confRaw) || score >= 70) bucket = 'High';
        else if (['low','lo','l'].includes(confRaw) || score < 40) bucket = 'Low';
        byConfidence[bucket] += 1;

        if (score <= 20) scoreBuckets['0-20'] += 1;
        else if (score <= 40) scoreBuckets['21-40'] += 1;
        else if (score <= 60) scoreBuckets['41-60'] += 1;
        else if (score <= 80) scoreBuckets['61-80'] += 1;
        else scoreBuckets['81-100'] += 1;

        if (dateStr) timeline[dateStr] = (timeline[dateStr] || 0) + 1;
        geo[country] = (geo[country] || 0) + 1;
      }

      const geoEntries = Object.entries(geo).sort((a,b) => b[1]-a[1]).slice(0,10);
      const geoTop = Object.fromEntries(geoEntries);
      const timelineSorted = Object.fromEntries(Object.entries(timeline).sort((a,b)=>a[0].localeCompare(b[0])));
      return { bySource, byType, byConfidence, scoreBuckets, timeline: timelineSorted, geo: geoTop };
    }

    function updateKpis(byConfidence, total) {
      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-high').textContent = byConfidence.High;
      document.getElementById('kpi-medium').textContent = byConfidence.Medium;
      document.getElementById('kpi-low').textContent = byConfidence.Low;
    }

    function destroyIfExists(key) { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }

    function drawBySource(map) {
      const ctx = document.getElementById('bySource');
      destroyIfExists('bySource');
      charts.bySource = new Chart(ctx, {
        type: 'bar',
        data: { 
          labels: Object.keys(map), 
          datasets: [{ 
            data: Object.values(map), 
            backgroundColor: '#3182ce',
            borderRadius: 8,
            borderWidth: 0
          }] 
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              color: '#1a202c',
              font: { size: 14, weight: 'bold' },
              anchor: 'end',
              align: 'top',
              offset: 4,
              formatter: (v) => v
            }
          },
          scales: {
            x: { 
              ticks: { 
                color: '#2d3748', 
                font: { size: 12, weight: '600' }
              },
              grid: { display: false }
            },
            y: { 
              ticks: { 
                color: '#2d3748', 
                font: { size: 12, weight: '600' }
              },
              grid: { color: '#e2e8f0' }
            }
          }
        }
      });
    }

    function renderSourceChips(sources) {
      const container = document.getElementById('source-chips');
      container.innerHTML = '';
      const palette = ['#3182ce','#e53e3e','#38a169','#805ad5','#dd6b20','#319795','#d53f8c'];
      sources.forEach((s, i) => {
        const span = document.createElement('span');
        span.className = 'chip' + (currentFilter === s ? ' active' : '');
        if (currentFilter !== s) {
          span.style.backgroundColor = '#ffffff';
          span.style.borderColor = palette[i % palette.length];
          span.style.color = palette[i % palette.length];
        }
        span.textContent = s;
        span.onclick = () => { currentFilter = (currentFilter === s) ? null : s; renderAll(); };
        container.appendChild(span);
      });
    }

    function drawByType(map) {
      const ctx = document.getElementById('byType');
      destroyIfExists('byType');
      const labels = Object.keys(map);
      const values = Object.values(map);
      charts.byType = new Chart(ctx, {
        type: 'pie',
        data: { 
          labels: labels, 
          datasets: [{ 
            data: values, 
            backgroundColor: ['#3182ce','#48bb78','#f6ad55','#e53e3e','#9f7aea','#38b2ac'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }] 
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { 
                color: '#2d3748', 
                font: { size: 12, weight: '600' },
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle',
                generateLabels: (chart) => {
                  const data = chart.data;
                  return data.labels.map((label, i) => ({
                    text: `${label}: ${data.datasets[0].data[i]}`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    hidden: false,
                    index: i
                  }));
                }
              }
            },
            datalabels: {
              color: '#ffffff',
              font: { size: 13, weight: 'bold' },
              formatter: (value, ctx) => {
                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(0);
                return percentage > 8 ? value : '';
              }
            }
          }
        }
      });
    }

    function drawByConfidence(map) {
      const ctx = document.getElementById('byConfidence');
      destroyIfExists('byConfidence');
      charts.byConfidence = new Chart(ctx, {
        type: 'doughnut',
        data: { 
          labels: ['High','Medium','Low'], 
          datasets: [{ 
            data: [map.High, map.Medium, map.Low], 
            backgroundColor: ['#e53e3e','#f6ad55','#48bb78'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }] 
        },
        options: { 
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { 
                color: '#2d3748', 
                font: { size: 12, weight: '600' },
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            datalabels: {
              color: '#ffffff',
              font: { size: 14, weight: 'bold' },
              formatter: (value) => value > 0 ? value : ''
            }
          }
        }
      });
    }

    function drawRiskRadar(buckets) {
      const ctx = document.getElementById('riskRadar');
      destroyIfExists('risk');
      charts.risk = new Chart(ctx, {
        type: 'radar',
        data: { 
          labels: Object.keys(buckets), 
          datasets: [{ 
            label: 'Risk Distribution', 
            data: Object.values(buckets), 
            backgroundColor: 'rgba(49,130,206,0.3)', 
            borderColor: '#3182ce',
            borderWidth: 2,
            pointBackgroundColor: '#3182ce',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#3182ce',
            pointRadius: 4,
            pointHoverRadius: 6
          }] 
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false,
          plugins: { 
            legend: { 
              display: true,
              position: 'top',
              labels: {
                color: '#2d3748',
                font: { size: 12, weight: '600' },
                padding: 15
              }
            },
            datalabels: { display: false }
          }, 
          scales: { 
            r: { 
              angleLines: { color: '#cbd5e0' },
              grid: { color: '#e2e8f0' },
              pointLabels: { 
                color: '#2d3748', 
                font: { size: 12, weight: '600' }
              },
              ticks: {
                color: '#718096',
                backdropColor: 'transparent',
                font: { size: 11 }
              }
            } 
          } 
        }
      });
    }

    function drawTimeline(series) {
      const ctx = document.getElementById('timeline');
      destroyIfExists('timeline');
      charts.timeline = new Chart(ctx, {
        type: 'line',
        data: { 
          labels: Object.keys(series), 
          datasets: [{ 
            label: 'Threats Over Time',
            data: Object.values(series), 
            borderColor: '#805ad5', 
            backgroundColor: 'rgba(128,90,213,0.1)', 
            tension: 0.4,
            fill: true,
            borderWidth: 3,
            pointRadius: 4,
            pointBackgroundColor: '#805ad5',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 6
          }] 
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: '#2d3748',
                font: { size: 12, weight: '600' },
                padding: 15
              }
            },
            datalabels: {
              color: '#1a202c',
              font: { size: 11, weight: 'bold' },
              anchor: 'end',
              align: 'top',
              offset: 4,
              formatter: (v) => v > 0 ? v : ''
            }
          },
          scales: {
            x: { 
              ticks: { 
                color: '#2d3748', 
                font: { size: 11, weight: '600' },
                maxRotation: 45,
                minRotation: 30
              },
              grid: { display: false }
            },
            y: { 
              ticks: { 
                color: '#2d3748', 
                font: { size: 11, weight: '600' }
              },
              grid: { color: '#e2e8f0' }
            }
          }
        }
      });
    }

    function drawGeo(map) {
      const ctx = document.getElementById('geo');
      destroyIfExists('geo');
      charts.geo = new Chart(ctx, {
        type: 'bar',
        data: { 
          labels: Object.keys(map), 
          datasets: [{ 
            data: Object.values(map), 
            backgroundColor: '#48bb78',
            borderRadius: 8,
            borderWidth: 0
          }] 
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            datalabels: {
              color: '#1a202c',
              font: { size: 12, weight: 'bold' },
              anchor: 'end',
              align: 'end',
              offset: 4,
              formatter: (v) => v
            }
          },
          scales: {
            x: { 
              ticks: { 
                color: '#2d3748', 
                font: { size: 11, weight: '600' }
              },
              grid: { color: '#e2e8f0' }
            },
            y: { 
              ticks: { 
                color: '#2d3748', 
                font: { size: 11, weight: '600' }
              },
              grid: { display: false }
            }
          }
        }
      });
    }

    fetchData();
  </script>
</body>
</html>